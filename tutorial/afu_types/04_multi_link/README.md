# Multi-PCIe Link AFUs

Beginning with release 2.12, the OPAE SDK supports encapsulation of multiple FPGA device connections as a single OPAE handle. Multi-link AFUs describe themselves in device feature lists as parents and children. Software searches for the parent by AFU ID and OPAE automatically opens connections to all of the parent AFU's children. All buffers mapped with fpgaPrepareBuffer\(\) become available at the same address in both the parent and its children.

The multi-device parent/child support is primarily aimed at achieving full bandwidth of bifurcated PCIe links. However, the mechanism within OFS and OPAE is based solely on SR-IOV and device feature lists (DFLs). Parent/child management behaves identically for VFs on the same PCIe link, separate bifuracted links, and even on separate FPGA cards within a host.

The parent/child DFL mechanism can be used for any application where the AFU exposes a collection of PCIe SR-IOV functions that all must be connected to a single software process. The parent/child relationship is described in the [AFU section](https://github.com/OFS/linux-dfl-backport/blob/intel/fpga-ofs-dev-6.6-lts/Documentation/fpga/dfl.rst#afu) of the DFL Linux documentation. Parents expose a DFHv1 header that enumerates children by per-child AFU IDs. Children use normal device feature headers and AFU IDs that match the parent's list of children. The same algorithm is available during simulation with opae-sim.

OFS provides a module that generates the primary DFH at MMIO address 0 for both parents and children. The module handles all MMIO traffic to the primary feature header and forwards all other MMIO requests to the AFU. Three variations of the hello world example are presented here in the tutorial:

* [hello_world_multi PIM](hello_world_multi/hw/rtl/pim/) instantiates a parent and up to two children, all using AXI-MM to write the "Hello world" string to host memory. The parent and children are all identical copies of the same AFU and each AFU has it's own private CSR space for commands. Choose this style when writing an AFU that will be replicated for throughput, e.g. on bifurcated FPGA links, and driven in parallel by a single process. In the example, the parent/child DFH is created in [ofs_plat_afu.sv](hello_world_multi/hw/rtl/pim/ofs_plat_afu.sv) and the replicated AFU is implemented in [hello_world_axi.sv](hello_world_multi/hw/rtl/pim/hello_world_axi.sv).
* [hello_world_multi afu_main](hello_world_multi/hw/rtl/afu_main/) is functionally equivalent to the PIM version, but uses PCIe TLP commands directly to emit the host memory write and to manage MMIO.
* [hello_world_shared PIM](hello_world_shared/hw/rtl/pim/) implements a different topology. It instantiates a single AFU that connects to all of the parent and child PCIe ports. A single CSR space in the parent receives commands for generating traffic on all PCIe links, including the children. Instantiation of parent/child feature lists is in [ofs_plat_afu.sv](hello_world_shared/hw/rtl/pim/ofs_plat_afu.sv) and a unified but multi-channel AFU is in [hello_world_shared.sv](hello_world_shared/hw/rtl/pim/hello_world_shared.sv). Choose this style for AFUs that route traffic through multiple PCIe links. No afu\_main equivalent is provided. The restructuring from the afu\_main hello\_world\_multi to hello\_world\_shim would be similar to the changes in the PIM version.

Please note that none of the examples in the tutorial attempt to optimize connections for multiple PCIe links. The examples simply connect to the first available SR-IOV ports. To optimize mapping to bifurcated PCIe links, either construct a topology with only a single function per link or pick host channel port indices associated with independent links. Each port's PCIe link ID is recorded along with the port's PF/VF settings.